const { connectToDatabase } = require('./db');
const fs = require("fs");
const axios = require("axios");

function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }  

async function scrapeFromVinted(legoId) {
  const url = `https://www.vinted.fr/api/v2/catalog/items?search_text=lego+${legoId}&page=1&per_page=96`;

  const headers = {
    "user-agent":
      "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36",
    "accept": "application/json, text/plain, */*",
    "x-csrf-token": "75f6c9fa-dc8e-4e52-a000-e09dd4084b3e",
    "x-anon-id": "3fc5f658-d94b-42fa-b1f0-e247c3ac8fc5",
    "cookie": "v_udt=RWptTlpRZkFyVzBEY2NCL2FKZUN2YWFzR01lTC0tM1RINzEyR0pMdVl1QVUrYi0tbFc0ZjNyZmx3dnNLUkJ6TEVzVnJxZz09; anon_id=3fc5f658-d94b-42fa-b1f0-e247c3ac8fc5; anon_id=3fc5f658-d94b-42fa-b1f0-e247c3ac8fc5; v_sid=12430877-1743938561; domain_selected=true; eupubconsent-v2=CQPcI7AQPcI7AAcABBENBkFsAP_gAAAAAChQJwtX_G__bXlj8T71aftkeY1f99h7rsQxBgbJk-4FyLvW_JwX32E7NAz6pqYKmRIAu3TBIQNlHIDURUCgaogVrSDMaEyUoTNKJ6BkiFMRY2cYCFxvm4lDeQCY5vr991c52R-t7dr83dzyy4hHv3a5_2S1WJCdAYctDfv8bROb-9IOd_x8v4v4_FgAAAAAABAAAAAAAAAAAAAAAAAAABYAAACwkEAABAAC4AKAAqABwADwAIIAZABqADwAJgAVQA3gB6AD8AISAQwBEgCOAEsAJoAVoAw4BlAGWANkAd8A9gD4gH2AfoBAACKQEXARiAjQCOAFBAKgAVcAuYBigDRAG0ANwAcQBDoCRAE7AKHAUeApEBTYC2AFyALvAXmAw0BkgDJwGXAM5gawBrIDYwG3gN1AcmA5cB44D2gIQgQvCAHAAHAAkAHOAQcAn4CPQEigJWATaAp8BYQC8gGIAMWgZCBkYDRgGpgNoAbcA3QB8gD9wICAQMggiCCYEGAIVgQuHALgAEQAOAA8AC4AJAAfgBoAHOAO4AgEBBwEIAJ-AVAAvQB0gEIAI9ASKAlYBMQCZQE2gKQAUmArsBagDEAGLAMhAZMA0YBpoDUwGvANoAbYA24Bx8DnQOfAfEA-2B-wH7gQPAgiBBgCDYEKx0EsABcAFAAVAA4ACAAF0AMgA1AB4AEwAKsAXABdADEAG8APQAfoBDAESAI4ASwAmgBRgCtAGGAMoAaIA2QB3gD2gH2AfsBFAEYAI4AUEAq4BYgC5gF5AMUAbQA3ABxADqAIdAReAkQBMgCdgFDgKPgU0BTYCrAFigLYAXAAuQBdoC7wF5gL6AYaAx4BkgDJwGVQMsAy4BnIDVQGsANvAbqA4sByYDlwHjgPaAfWBAECFpAAkAAgANAA5wCxAI9ATaApMBeQDUwG2ANuAc-A-IB-wEDwIMAQbAhWQgOAALAAoAC4AKoAXAAxABvAD0AO8AigBHACUgFBAKuAXMAxQBtADqQKaApsBYoC0QFwALkAZOAzkBqoDxwIWkoEYACAAFgAUAA4ADwAJgAVQAuABigEMARIAjgBRgCtAGyAO8AfgBHACrgGKAOoAh0BF4CRAFHgKbAWKAtgBeYDJwGWAM5AawA28B7QEDyQA4AC4A7gCAAFQAR6AkUBKwCbQFJgMWAbkA_cCCIEGCkDYABcAFAAVAA4ACCAGQAaAA8ACYAFUAMQAfoBDAESAKMAVoAygBogDZAHfAPsA_QCLAEYAI4AUEAq4BcwC8gGKANoAbgBDoCLwEiAJ2AUOApsBYoC2AFwALkAXaAvMBfQDDQGSAMngZYBlwDOYGsAayA28BuoDkwHjgPaAhCBC0oAfAAuACQARwA5wB3AEAAJEAWIA14B2wD_gI9ASKAmIBNoCkAFPgK7AXkAxYBkwDUwGvAPigfsB-4EDAIHgQTAgwBBsCFZaACApsAA.f_wAAAAAAAAA; OTAdditionalConsentString=1~43.46.55.61.70.83.89.93.108.117.122.124.135.143.144.147.149.159.192.196.211.228.230.239.259.266.286.291.311.318.320.322.323.327.367.371.385.394.407.415.424.430.436.445.486.491.494.495.522.523.540.550.559.560.568.574.576.584.587.591.737.802.803.820.821.839.864.899.904.922.931.938.979.981.985.1003.1027.1031.1040.1046.1051.1053.1067.1092.1095.1097.1099.1107.1135.1143.1149.1152.1162.1166.1186.1188.1205.1215.1226.1227.1230.1252.1268.1270.1276.1284.1290.1301.1307.1312.1345.1356.1375.1403.1415.1416.1421.1423.1440.1449.1455.1495.1512.1516.1525.1540.1548.1555.1558.1570.1577.1579.1583.1584.1591.1603.1616.1638.1651.1653.1659.1667.1677.1678.1682.1697.1699.1703.1712.1716.1721.1725.1732.1745.1750.1765.1782.1786.1800.1810.1825.1827.1832.1838.1840.1842.1843.1845.1859.1866.1870.1878.1880.1889.1899.1917.1929.1942.1944.1962.1963.1964.1967.1968.1969.1978.1985.1987.2003.2008.2027.2035.2039.2047.2052.2056.2064.2068.2072.2074.2088.2090.2103.2107.2109.2115.2124.2130.2133.2135.2137.2140.2147.2156.2166.2177.2186.2205.2213.2216.2219.2220.2222.2225.2234.2253.2279.2282.2292.2309.2312.2316.2322.2325.2328.2331.2335.2336.2343.2354.2358.2359.2370.2376.2377.2387.2400.2403.2405.2407.2411.2414.2416.2418.2425.2440.2447.2461.2465.2468.2472.2477.2481.2484.2486.2488.2493.2498.2501.2510.2517.2526.2527.2532.2535.2542.2552.2563.2564.2567.2568.2569.2571.2572.2575.2577.2583.2584.2596.2604.2605.2608.2609.2610.2612.2614.2621.2628.2629.2633.2636.2642.2643.2645.2646.2650.2651.2652.2656.2657.2658.2660.2661.2669.2670.2677.2681.2684.2687.2690.2695.2698.2713.2714.2729.2739.2767.2768.2770.2772.2784.2787.2791.2792.2798.2801.2805.2812.2813.2816.2817.2821.2822.2827.2830.2831.2834.2838.2839.2844.2846.2849.2850.2852.2854.2860.2862.2863.2865.2867.2869.2873.2874.2875.2876.2878.2880.2881.2882.2883.2884.2886.2887.2888.2889.2891.2893.2894.2895.2897.2898.2900.2901.2908.2909.2916.2917.2918.2919.2920.2922.2923.2927.2929.2930.2931.2940.2941.2947.2949.2950.2956.2958.2961.2963.2964.2965.2966.2968.2973.2975.2979.2980.2981.2983.2985.2986.2987.2994.2995.2997.2999.3000.3002.3003.3005.3008.3009.3010.3012.3016.3017.3018.3019.3028.3034.3038.3043.3052.3053.3055.3058.3059.3063.3066.3068.3070.3073.3074.3075.3076.3077.3089.3090.3093.3094.3095.3097.3099.3100.3106.3109.3112.3117.3119.3126.3127.3128.3130.3135.3136.3145.3150.3151.3154.3155.3163.3167.3172.3173.3182.3183.3184.3185.3187.3188.3189.3190.3194.3196.3209.3210.3211.3214.3215.3217.3219.3222.3223.3225.3226.3227.3228.3230.3231.3234.3235.3236.3237.3238.3240.3244.3245.3250.3251.3253.3257.3260.3270.3272.3281.3288.3290.3292.3293.3296.3299.3300.3306.3307.3309.3314.3315.3316.3318.3324.3328.3330.3331.3531.3731.3831.4131.4531.4631.4731.4831.5231.6931.7235.7831.7931.8931.9731.10231.10631.10831.11031.11531.12831.13632.13731.14034.14237.14332.15731.16831.16931.21233.23031.25131.25731.25931.26031.26831.27731.27831.28031.28731.28831.29631.32531.33631.34231.34631.36831.39131.39531.40632.41531.43631.43731; _lm_id=AS6495OP7V8CSK1M; _gcl_au=1.1.2073181903.1743962384; _ga=GA1.1.1671815830.1743962385; __podscribe_vinted_referrer=_; __podscribe_vinted_landing_url=https://www.vinted.fr/; __podscribe_did=pscrb_5dab1832-0376-408a-c7f2-c3befa743bbf; OptanonAlertBoxClosed=2025-04-06T18:00:03.982Z; _cc_id=70c61e890f342d7c40af5582f34a119d; panoramaId_expiry=1744567253275; panoramaId=d1704e68439e8790d6046d87be92185ca02c54bfb410efdb49aceea1e75532f6; panoramaIdType=panoDevice; _fbp=fb.1.1743962511514.131640981976607687; viewport_size=360; access_token_web=eyJraWQiOiJFNTdZZHJ1SHBsQWp1MmNObzFEb3JIM2oyN0J1NS1zX09QNVB3UGlobjVNIiwiYWxnIjoiUFMyNTYifQ.eyJhcHBfaWQiOjQsImNsaWVudF9pZCI6IndlYiIsImF1ZCI6ImZyLmNvcmUuYXBpIiwiaXNzIjoidmludGVkLWlhbS1zZXJ2aWNlIiwiaWF0IjoxNzQzOTc1NTY0LCJzaWQiOiIxMjQzMDg3Ny0xNzQzOTM4NTYxIiwic2NvcGUiOiJwdWJsaWMiLCJleHAiOjE3NDM5ODI3NjQsInB1cnBvc2UiOiJhY2Nlc3MifQ.XjHeuaBUADgwjI55DnGz6Bvg72r1hEl7PCrzll_MTSyTUkT6hBsjoxYJORVEd4X3HFb8QISkAGqVaj6kTFJKEDKomViR39uAsWYonRK93cDm4HsCtQGMe_ZP5MTNFSsOsmbVNQsoVAdSjZFdVkILEQWk067AGt1V8APKXha_qCIlMKbx2MipClqI4OYQl7lXjJjhU_hZw8fgW3wXnJ3fc-b1sxKcvgTU2uTo2RoLYhpy6riQXmhTSGXS6983NdtkZkk2WVrXadHfvH3wRR3ry6nxfYisqT1NQiSRQgL3ML4Pg1iU-0LuzY4Xieae4Ypt68pKsVCrxx2sCzD-Q2Ygag; refresh_token_web=eyJraWQiOiJFNTdZZHJ1SHBsQWp1MmNObzFEb3JIM2oyN0J1NS1zX09QNVB3UGlobjVNIiwiYWxnIjoiUFMyNTYifQ.eyJhcHBfaWQiOjQsImNsaWVudF9pZCI6IndlYiIsImF1ZCI6ImZyLmNvcmUuYXBpIiwiaXNzIjoidmludGVkLWlhbS1zZXJ2aWNlIiwiaWF0IjoxNzQzOTc1NTY0LCJzaWQiOiIxMjQzMDg3Ny0xNzQzOTM4NTYxIiwic2NvcGUiOiJwdWJsaWMiLCJleHAiOjE3NDQ1ODAzNjQsInB1cnBvc2UiOiJyZWZyZXNoIn0.oiT_APRpfo9K-RXL1i4_tLS4xvQl5anhxv1JE569KE5EgnQWEdF3S-_WWwvF2kku33qlkBzrj-IPZMJv44Uod14gVS5z410XPnpG0nCObfz445nDCHh51NbT1vZdGScPFgv2xdhrH03k9zTaEm1BE5iuRsaNuf6gNsAABLg5ffpKIH63s34dkKbpWpNJ6KM1FGNf-o--OjiPpb6_cS4p-pr7cC75p0yuibgC96SDKZgtrhIUMugjRU0cuzCuQJaKds8zw8vRMT_DibUqyfXMf5x_wBag2qeudu8DN8j6Egq5XNNq1ZK4zTvzCOowU1PJn5X-0rEFtpl-wsvRN7SowQ; __gads=ID=86e42b11bd2062c9:T=1743962513:RT=1743975569:S=ALNI_MZOGEh6pbaB4BdLEEfV_Pjw0zAPjA; __gpi=UID=0000108c200177ad:T=1743962513:RT=1743975569:S=ALNI_MZuu3CIExsZgLxvwpQ6kMeRIANuew; __eoi=ID=00379e47c3398e29:T=1743962513:RT=1743975569:S=AA-AfjZVTeuIwRPeHN7GTo725wsd; __cf_bm=Yg7_QqJGpSW6Lea6HGpQLb6bYvPs_TOfggcFBxHIsxY-1743975605-1.0.1.1-LzBtidx28ltATLYYx4CaS4b2_dcnpVie1v2X1cdA_Jxqfhx2nCQC3WNX3wVVYkRPPvw_S24vfqSV.9Lb4T2IikM8cDBD7zPssehnzfkIDx0YgfU1KVnge52JTKSeffSL; cf_clearance=3Lo7MuNgvc19SQQzTeXbn3izW9HG8QbFDpG0vIa63gI-1743975616-1.2.1.1-A15AL9_Vs1sZOI9xPZW0a3lnsC8hnuIOj.bcelDuctxq7oMJHV8H8UoHTG5.rG8amwZo3e_mQhcS7CflXQdbhZ1Zs2OHl3cNTf2AO_RtZndlEZocNhfkPUmXRFJBZu_laqk2PfpHtb7c7M7Y1kGjMf.Q.oCDaJm2daLa7712aTLsUe8lS.x2MYogXA9zOZSnCSp1YMDoe0nJ_sZ0W2yvS_cfwHdVq3WVNqxavMySd.FKpqmHKcOw9XntjozPjNoGbjJR43XwGhJZS9Lay8eZMOoUPaOIWrOiQTKwPXLakT_1EC2lmFx48PzbF0ERGyyS_eco5v83YMXbTnt_7vjHoLUaKgc4hmJX3NHCo.D.5mI; datadome=Wmpj3CgkBBsdCoy0xaUQUBHw4OJWiw1jE2a3xd8l7_lOczorKt1F_iGfG4_~WYo470Akqh2xlqFzTM9V2ScPJcupO3l3~nZ5X~dM8DElfl7A25A4NXeXJIwZIabV21H9; cto_bundle=Qnb5PV9nSU1jb0pnTmJaR0ZiS3BRWmhXZ1J1VTRBWWRZbW5kWFBMVlJ0aEFyMnUxY1RsQlJJaWhiQ3BUbjBsRXo1cXdHdUczdFJIdlFEN1AwczNSNGQxSXVGNnlLZ0k4aUdoMm5oZ01sSG5qRmdQYWpKY3REd3ZhYllXazZkNDBOSkFMRW8lMkZBSXBlS1ZuSWxhWmVHaDZCQ21WdyUzRCUzRA; _dd_s=rum=0&expire=1743976520439; _vinted_fr_session=ZWNJa2JNL2ZHSEtzY3hYMzRTZ3VSQTJ4T0llKy80aUo4TDJNdWlidmh5NEsxL0tRZEY0TTZQNXdPQTY2TTNWKzlSSHRqbEF6RTZrdDNBczVhQlZjVS9OclBOdUhvd21ZR3VCbk1ndWZQYWdPYlAveGFlZDAzR1BYWUFONGFia2lnMHhLQWt3SGl5c3hOT0xJaE1mMzQxdkFkMkRXZmdBRjV1MzgrSTU3a2dNVGJvamU2b0tJS1VEcXRTUVdBeE92VDBqZnc1VU54bWVkN2lvZmZTUlMvQXZsYUhBZGJQLzRzaXc2TnBwMFUzcUlVaGVrWjV6R01RTEp4MmlzSzhTekMrOGxIcEZTUUtHTnUyVjlwMW44bDZ0NWhlSytVU21ubWMzRFk4KzF4aW9vaFIvYU9leEp6Yll0SktRQmdLRlJ5dG5oeHJkRG5jeEZGdW9QclU5MHRRZDJnbkNyWUxVZnNxdzdVRjNvZDRwRzBxOWluVjhHUGpXTklCYnlCK3dwemtjOGdnUkNucE9kay9IdlFqTHVGUDk0NUpPVDl5aWdwT1JkakZaNXBXM3ZQMXBzdisxZHNHRk4xOEtuTkpNTnFiN3RsQ1N1M1dNU2VJdDgrSVZ3SHJIbGNRdWdDc2NkT1JIaUkrQ2FIaStyRndCYmcydEJ4NnhzcjU3WG14NTE4WFBaTnZlaU41ZjlRNzEvOHVja1BJb3BwaU9hUm9oamRPVDNOSHpSZWhhaU5xNDY0c3dRdFh2NUc5Wkp3aUkyaGlYT09JM0Rmc0NZb1Vrdk11U0FxeGJRb2FOdHBJMGkvMm5oRmRGWjJLVjVpL1pDYlE0MzdzR0JURkcvZURZa3ExWG5kb29QSE5iUlZUZ051ZjJpU3lvUnp6dXBOWlMyMlJzSHp1bjhsY2ZJMXdLd3VscG45REptYlNMMURsZjhrTWphVU5MeUpwQm1TdHBuaFU1eVF1a3lDcXc0WEVjd1ZDbFRldnpJZzVNamRIREx5Rk54eFJFTXFBb2Y4amVKbWhGT05JaFZhVW00ZHBITGdZUjdDWE54ck9Jb1ZSMFFEWi9lckJ2VGJqdHlSd2EzZGdYKzZPRTBWb3FlZW8xRGZ6NTJYOTI0WWsvblJJbGlhNm9oWGlGQVJ5SG1TZUwwcldLQjZPQ0tjQ3IvdmdtU0k1SnZ3NEtlYVliaHhqWXRnb243SUlTNEhkejUyYVU0OXNFeTlPZDl4enVnSDRiSmNLZnR3Yi83VG9QRjducTdnRkttL2czQVBSS2pvWFBtNm0wcThuV0lSTkcvanJ0NDVaZjVKQ1ROWXRtNTlZMFJaZXJmOUxQUHFGbVdpVGIvc3ZnN25keHVnUjVXVHlEY1lKVzNXWDVvUEFWeUdQUWhOemxBU29zL2NaUkhaam16Q09nRlY2MUkrZ2tnNkNKYzJDSXQzY0dvTEF0bUNFRnllYTZWRDhicVQ5eHdxTU9ZaU5CUTNCbEVUS0E0eEtMdU5rWmIwb1NvVGJLcDRaWmJ5Vi9LblFwK2U1YUZJVTltVnhvOW9mYktwNW1vdmFQZVhCSlV4TlB6enVMeFVWMUE0M21Lc1lhcEh3b1BBN1RGaXhkU2JUSkVNRDNubDRZVEpzV0xWYU44aW1JZ0NGNmI2cGNzL2lWV0dnQ1dINDNNVmNTUTcrV0FacEtTYTVQZ2VuK3MwdVloOUUrLzBqcDZPblV2My9FdndVZlJqNEtaeVpRVEpJVU1rQzhoQ2pBSUZqcnVjbk1HNVY2d2Z2TGVjMkxKekMzRlJSOGtCVStrdXpUSG0yYyt0SE1aWlVQV3hFcmkzM1ZiSFN5MGtxclJXNDJwVzRrRGRYLy9pbTZ6dzVBamNzWGNtcGJlTWlzMFRvd3NzM0RTbXVubEdoeGoydko0N21yZlFZMkJBTmFXVmpIdi9Qa3p6MTdqT3NFaGZqZnZNS2oyUWdHb0xYZ2FUbVl0NEdLRUM4d2xtY3FTSDhoUlplRTBGcHRRNmJYaE93dDFIUmhqT2pWR3FQSFZ4M2ozL1JiK0RRekJ3TVZoV3hMWVBuUFM2TDAzTDNDNEl4azJqcFdTQUUrMnphMG1RTVBIOUMzSGVocHJUWkVBL25VM2lobGNCOC94Q3FwRkhpVFdiVFAzWWx2T21EdjA2OTBtd3Y0VlR2c2dzVUx4ZlBTZjIwRjlUSk1PdEhialdodElSSS81R0VRTE1UNjNnbkxvclJyd2NmenQ2OEEvK2ZBRDExUjJoS0hNL3lTS1BEQmJFLzNhT1V0dEpra1lWQisvdmhwTVhCdWg1R0h3Z1lXM1pHWHBPL3kzRVFxbmVnQksranBjM0xwbjdXWjV5aURiQjdFMkdoNERGaHkrdCtraWg3dFZISnZTNFVMSy0tUUZiaFoxcjFITzRBUDJlQktVdmd2Zz09--e270146bca5adb5433ab3fc193fb3ec5bffefb2e; OptanonConsent=isGpcEnabled=0&datestamp=Sun+Apr+06+2025+23%3A40%3A49+GMT%2B0200+(heure+d%E2%80%99%C3%A9t%C3%A9+d%E2%80%99Europe+centrale)&version=202312.1.0&browserGpcFlag=0&isIABGlobal=false&consentId=3fc5f658-d94b-42fa-b1f0-e247c3ac8fc5&interactionCount=16&hosts=&landingPath=NotLandingPage&groups=C0001%3A1%2CC0002%3A1%2CC0003%3A1%2CC0004%3A1%2CC0005%3A1%2CV2STACK42%3A1%2CC0015%3A1%2CC0035%3A1&genVendors=V2%3A1%2CV1%3A1%2C&AwaitingReconsent=false&geolocation=FR%3BIDF; _ga_8H12QY46R8=GS1.1.1743975553.3.1.1743975649.0.0.0; _ga_ZJHK1N3D75=GS1.1.1743975553.3.1.1743975649.0.0.0; banners_ui_state=PENDING"
  };

  try {
    const res = await axios.get(url, { headers });
    return res.data.items || [];
  } catch (e) {
    if (e.response) {
      console.error(`❌ Erreur HTTP ${e.response.status} pour ${legoId}`);
    } else {
      console.error(`❌ Erreur réseau pour ${legoId} : ${e.message}`);
    }
    return [];
  }
}

async function main() {
  let dealabsData;
  try {
    const rawData = fs.readFileSync("dealabs.json", "utf-8");
    dealabsData = JSON.parse(rawData);
  } catch (e) {
    console.error("❌ Erreur lecture dealabs.json :", e.message);
    return;
  }

  const ids = Array.isArray(dealabsData)
    ? dealabsData.map(item => item.id).filter(Boolean)
    : [dealabsData.id];

  console.log(`🧩 ${ids.length} sets LEGO à scraper\n`);

  let allResults = [];

  for (const id of ids) {
    console.log(`🔍 Scraping LEGO ${id}`);
    const items = await scrapeFromVinted(id);

    if (items.length > 0) {
      const formatted = items.map(item => ({
        lego_id: id,
        title: item.title,
        price: item.price?.amount,
        currency: item.price?.currency,
        url: `https://www.vinted.fr/items/${item.id}`
      }));

      allResults.push(...formatted);
      console.log(`✅ ${formatted.length} résultats ajoutés\n`);
    } else {
      console.log(`⚠️ Aucun résultat trouvé pour ${id}\n`);
    }
    await delay(1000); // attend 1 seconde
  }

  // 💾 Sauvegarde locale JSON
  fs.writeFileSync("vinted.json", JSON.stringify(allResults, null, 2));
  console.log(`📦 Tous les résultats ont été sauvegardés dans vinted.json`);

  if (allResults.length > 0) {
    try {
      const { db, client } = await connectToDatabase();
      const collection = db.collection("sales");
  
      await collection.insertMany(allResults);
      console.log("💾 Données insérées dans MongoDB");
  
      await client.close(); // ✅ on ferme proprement
    } catch (err) {
      console.error("❌ Erreur insertion MongoDB :", err.message);
    }
  } else {
    console.log("⚠️ Aucune donnée à insérer dans MongoDB");
  }
}

main();
